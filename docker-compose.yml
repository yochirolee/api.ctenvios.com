services:
   postgres:
      image: postgres:15-alpine
      container_name: ctenvios-postgres
      restart: unless-stopped
      environment:
         POSTGRES_USER: ${POSTGRES_USER:-ctenvios}
         POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
         POSTGRES_DB: ${POSTGRES_DB:-ctenvios}
      command: postgres -c wal_level=logical -c max_replication_slots=10 -c max_wal_senders=10
      volumes:
         - postgres_data:/var/lib/postgresql/data
      healthcheck:
         test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ctenvios}"]
         interval: 10s
         timeout: 5s
         retries: 5
         start_period: 10s
      ports:
         - "5433:5432"
      networks:
         - ctenvios-network

   api:
      build:
         context: .
         dockerfile: Dockerfile
      container_name: ctenvios-api
      restart: unless-stopped
      ports:
         - "${PORT:-3000}:3000"
         - "5556:5556"  # Prisma Studio
      environment:
         - NODE_ENV=${NODE_ENV:-production}
         - PORT=${PORT:-3000}
         - DATABASE_URL=postgresql://${POSTGRES_USER:-ctenvios}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-ctenvios}?schema=public
         - DIRECT_URL=postgresql://${POSTGRES_USER:-ctenvios}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-ctenvios}?schema=public
         - JWT_SECRET=${JWT_SECRET}
         - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
         - RESEND_API_KEY=${RESEND_API_KEY:-}
         - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
         - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
         - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER:-}
         - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
         - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
         - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      depends_on:
         postgres:
            condition: service_healthy
      networks:
         - ctenvios-network
      volumes:
         # Optional: mount assets if you need to update them without rebuilding
         - ./assets:/app/assets:ro

   electric-sql-api:
      image: docker.io/electricsql/electric:latest
      container_name: ctenvios-electric
      restart: unless-stopped
      env_file:
         - .env
      environment:
         DATABASE_URL: postgresql://${POSTGRES_USER:-ctenvios}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-ctenvios}
         ELECTRIC_INSECURE: ${ELECTRIC_INSECURE:-true}
      ports:
         - "3006:3000"
      depends_on:
         postgres:
            condition: service_healthy
      networks:
         - ctenvios-network

volumes:
   postgres_data:
      driver: local

networks:
   ctenvios-network:
      driver: bridge