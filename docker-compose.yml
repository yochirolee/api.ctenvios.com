services:
   postgres:
      image: postgres:15-alpine
      container_name: ctenvios-postgres
      restart: unless-stopped
      environment:
         POSTGRES_USER: ${POSTGRES_USER:-ctenvios}
         POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
         POSTGRES_DB: ${POSTGRES_DB:-ctenvios}
      volumes:
         - postgres_data:/var/lib/postgresql/data
      healthcheck:
         test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ctenvios}"]
         interval: 10s
         timeout: 5s
         retries: 5
         start_period: 10s
      ports:
         - "5432:5432"
      networks:
         - ctenvios-network
      # Port not exposed externally for security (only accessible from API container)

   api:
      build:
         context: .
         dockerfile: Dockerfile
      container_name: ctenvios-api
      restart: unless-stopped
      ports:
         - "${PORT:-3000}:3000"
         - "5555:5555"  # Prisma Studio
      environment:
         - NODE_ENV=${NODE_ENV:-production}
         - PORT=${PORT:-3000}
         - DATABASE_URL=postgresql://${POSTGRES_USER:-ctenvios}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-ctenvios}?schema=public
         - DIRECT_URL=postgresql://${POSTGRES_USER:-ctenvios}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-ctenvios}?schema=public
         - JWT_SECRET=${JWT_SECRET}
         - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
         - RESEND_API_KEY=${RESEND_API_KEY:-}
         - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
         - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
         - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER:-}
      depends_on:
         postgres:
            condition: service_healthy
      networks:
         - ctenvios-network
      volumes:
         # Optional: mount assets if you need to update them without rebuilding
         - ./assets:/app/assets:ro

volumes:
   postgres_data:
      driver: local

networks:
   ctenvios-network:
      driver: bridge
