// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
    provider = "postgresql"
}

// --- MODELOS PRINCIPALES (CORE) ---

model User {
    id                       String                  @id @default(uuid())
    name                     String
    email                    String                  @unique
    emailVerified            Boolean                 @default(false)
    phone                    String?
    image                    String?
    createdAt                DateTime                @default(now())
    updatedAt                DateTime                @updatedAt
    created_by               String?
    forwarder_id             Int?
    forwarder                Forwarder?              @relation(fields: [forwarder_id], references: [id])
    agency_id                Int?
    agency                   Agency?                 @relation(fields: [agency_id], references: [id], onDelete: Cascade)
    carrier_id               Int?
    carrier                  Carrier?                @relation(fields: [carrier_id], references: [id], onDelete: SetNull)
    role                     Roles                   @default(AGENCY_SALES)
    payments                 Payment[]
    discounts                Discount[]
    sessions                 Session[]
    accounts                 Account[]
    banned                   Boolean?                @default(false)
    banReason                String?
    banExpires               DateTime?
    orders                   Order[]                 @relation("user")
    order_history            OrderHistory[]
    created_dispatches       Dispatch[]              @relation("created_by")
    received_dispatches      Dispatch[]              @relation("received_by")
    paid_dispatches          Dispatch[]              @relation("paid_by")
    parcels                  Parcel[]
    parcels_events           ParcelEvent[]
    app_logs                 AppLog[]
    created_issues           Issue[]                 @relation("created_issues")
    assigned_issues          Issue[]                 @relation("assigned_issues")
    resolved_issues          Issue[]                 @relation("resolved_issues")
    issue_comments           IssueComment[]
    issue_attachments        IssueAttachment[]
    created_legacy_issues    LegacyIssue[]           @relation("created_legacy_issues")
    assigned_legacy_issues   LegacyIssue[]           @relation("assigned_legacy_issues")
    resolved_legacy_issues   LegacyIssue[]           @relation("resolved_legacy_issues")
    legacy_issue_comments    LegacyIssueComment[]    @relation("legacy_issue_comments")
    legacy_issue_attachments LegacyIssueAttachment[] @relation("legacy_issue_attachments")

    @@index([agency_id, role])
    @@index([carrier_id, role])
    @@map("user")
}

model Agency {
    id                  Int            @id @default(autoincrement())
    name                String
    address             String
    contact             String
    phone               String
    email               String         @unique
    logo                String?
    website             String?
    created_at          DateTime       @default(now())
    updated_at          DateTime       @updatedAt
    forwarder_id        Int
    forwarder           Forwarder      @relation(fields: [forwarder_id], references: [id])
    parent_agency_id    Int?
    parent_agency       Agency?        @relation("AgencyHierarchy", fields: [parent_agency_id], references: [id], onDelete: SetNull)
    child_agencies      Agency[]       @relation("AgencyHierarchy")
    services            Service[]
    users               User[]
    products            Product[]
    shipping_rates      ShippingRate[]
    customs_rates       CustomsRates[]
    surcharges          Surcharge[]
    customers           Customer[]
    receivers           Receiver[]
    order_items         OrderItem[]
    counters            Counter[]
    partners            Partner[]
    issues              Issue[]
    legacy_issues       LegacyIssue[]  @relation("legacy_issues")
    agency_type         AgencyType     @default(AGENCY)
    is_active           Boolean        @default(false)
    commission_rate     Float?         @default(0.0)
    orders              Order[]
    created_dispatches  Dispatch[]     @relation("created_dispatches")
    received_dispatches Dispatch[]     @relation("received_dispatches")
    parcels             Parcel[]

    @@index([forwarder_id, is_active])
    @@index([parent_agency_id])
}

model Customer {
    id                Int        @id @default(autoincrement())
    first_name        String
    middle_name       String?
    last_name         String
    second_last_name  String?
    identity_document String?    @unique
    email             String?    @unique
    mobile            String
    address           String?
    created_at        DateTime   @default(now())
    updated_at        DateTime   @updatedAt
    receivers         Receiver[]
    agency_id         Int?
    agency            Agency?    @relation(fields: [agency_id], references: [id], onDelete: Cascade)
    is_active         Boolean    @default(true)
    orders            Order[]

    @@unique([mobile, first_name, last_name])
    @@index([agency_id, created_at(sort: Desc)]) //  MS IMPORTANTE
    @@index([created_at(sort: Desc)]) // Para admins
    @@index([id]) // Para JOINs
    @@index([first_name, last_name]) // For name searches
    @@index([mobile]) // For mobile searches
}

model Receiver {
    id               Int        @id @default(autoincrement())
    first_name       String
    middle_name      String?
    last_name        String
    second_last_name String?
    passport         String?    @unique
    ci               String     @unique @db.VarChar(11)
    email            String?    @unique
    mobile           String?
    phone            String?
    address          String
    created_at       DateTime   @default(now())
    updated_at       DateTime   @updatedAt
    customers        Customer[]
    agency_id        Int?
    agency           Agency?    @relation(fields: [agency_id], references: [id], onDelete: Cascade)
    province_id      Int
    province         Province   @relation(fields: [province_id], references: [id])
    city_id          Int
    city             City       @relation(fields: [city_id], references: [id])
    orders           Order[]

    @@index([mobile]) //  B煤squeda por m贸vil
    @@index([ci]) //  B煤squeda por CI
    @@index([first_name, last_name]) //  B煤squeda por nombre completo
    @@index([agency_id]) //  Para JOINs
}

model Order {
    id                     Int            @id @default(autoincrement())
    partner_order_id       String?
    customer_id            Int
    customer               Customer       @relation(fields: [customer_id], references: [id])
    receiver_id            Int
    receiver               Receiver       @relation(fields: [receiver_id], references: [id])
    service_id             Int
    service                Service        @relation(fields: [service_id], references: [id])
    order_items            OrderItem[]
    parcels                Parcel[]
    total_in_cents         Int            @default(0)
    paid_in_cents          Int            @default(0)
    requires_home_delivery Boolean        @default(true)
    created_at             DateTime       @default(now())
    updated_at             DateTime       @updatedAt
    user_id                String
    user                   User           @relation("user", fields: [user_id], references: [id])
    agency_id              Int
    agency                 Agency         @relation(fields: [agency_id], references: [id], onDelete: Cascade)
    order_history          OrderHistory[]
    payments               Payment[]
    payment_status         PaymentStatus  @default(PENDING)
    discounts              Discount[]
    stage                  OrderStage     @default(BILLING)
    status                 Status         @default(IN_AGENCY)
    partner                Partner?       @relation(fields: [partner_id], references: [id])
    partner_id             Int?
    issues                 Issue[]

    @@index([agency_id, created_at(sort: Desc)]) //  MS IMPORTANTE
    @@index([created_at(sort: Desc)]) // Para admins
    @@index([customer_id]) // Para JOINs
    @@index([receiver_id]) // Para JOINs
}

model OrderItem {
    hbl                    String        @id
    description            String
    created_at             DateTime      @default(now())
    updated_at             DateTime      @updatedAt
    weight                 Decimal       @default("0.00")
    volume                 Float?        @default(0)
    length                 Float?
    width                  Float?
    height                 Float?
    service_id             Int
    service                Service       @relation(fields: [service_id], references: [id])
    quantity               Int           @default(1)
    //Snapshot de los precios
    price_in_cents         Int           @default(0)
    unit                   Unit          @default(PER_LB)
    ///////////////////////
    delivery_fee_in_cents  Int?          @default(0)
    customs_fee_in_cents   Int           @default(0)
    insurance_fee_in_cents Int?          @default(0)
    charge_fee_in_cents    Int?          @default(0)
    rate_id                Int
    rate                   ShippingRate  @relation(fields: [rate_id], references: [id])
    customs_rates_id       Int?
    customs_rates          CustomsRates? @relation(fields: [customs_rates_id], references: [id])
    agency_id              Int
    agency                 Agency        @relation(fields: [agency_id], references: [id], onDelete: Cascade)
    status                 Status        @default(IN_AGENCY)
    order                  Order         @relation(fields: [order_id], references: [id], onDelete: Cascade)
    order_id               Int
    parcel_id              Int
    parcel                 Parcel        @relation(fields: [parcel_id], references: [id])
    issues                 Issue[]

    @@index([order_id])
    @@index([hbl])
    @@index([agency_id, created_at])
}

model Parcel {
    id                  Int           @id @default(autoincrement())
    tracking_number     String        @unique
    agency_id           Int?
    agency              Agency?       @relation(fields: [agency_id], references: [id], onDelete: SetNull)
    current_agency_id   Int?
    order_id            Int?
    order               Order?        @relation(fields: [order_id], references: [id], onDelete: SetNull)
    service_id          Int?
    service             Service?      @relation(fields: [service_id], references: [id], onDelete: SetNull)
    description         String
    weight              Decimal       @default("0.00")
    status              Status        @default(IN_AGENCY)
    current_location_id Int?
    current_location    Location?     @relation(fields: [current_location_id], references: [id])
    created_at          DateTime      @default(now())
    updated_at          DateTime      @updatedAt
    order_items         OrderItem[]
    events              ParcelEvent[]
    dispatch_id         Int?
    dispatch            Dispatch?     @relation(fields: [dispatch_id], references: [id])
    user_id             String
    user                User          @relation(fields: [user_id], references: [id])
    issues              Issue[]
    issue_parcels       IssueParcel[] // Parcels afectados en issues

    @@index([tracking_number])
    @@index([dispatch_id]) // Add this for faster dispatch queries
}

model ParcelEvent {
    id          Int       @id @default(autoincrement())
    parcel_id   Int
    parcel      Parcel    @relation(fields: [parcel_id], references: [id], onDelete: Cascade)
    created_at  DateTime  @default(now())
    updated_at  DateTime  @updatedAt
    status      Status    @default(IN_AGENCY)
    user_id     String
    user        User      @relation(fields: [user_id], references: [id])
    location_id Int?
    location    Location? @relation(fields: [location_id], references: [id])
}

model Location {
    id             Int           @id @default(autoincrement())
    name           String
    created_at     DateTime      @default(now())
    updated_at     DateTime      @updatedAt
    parcels        Parcel[]
    parcels_events ParcelEvent[]
}

// --- MODELOS DE DESPACHO ---
model Dispatch {
    id               Int    @id @default(autoincrement())
    //DEUDOR/ACREEDOR
    sender_agency_id Int
    sender_agency    Agency @relation("created_dispatches", fields: [sender_agency_id], references: [id])

    receiver_agency_id Int?
    receiver_agency    Agency? @relation("received_dispatches", fields: [receiver_agency_id], references: [id], onDelete: SetNull)

    status DispatchStatus @default(DRAFT)

    declared_parcels_count Int @default(0) //Declarador por el sender_agency
    received_parcels_count Int @default(0) //Recibido por el receiver_agency

    parcels Parcel[]

    declared_weight Decimal @default("0.00")
    weight          Decimal @default("0.00")

    declared_cost_in_cents Int           @default(0)
    cost_in_cents          Int           @default(0)
    //PAYMENTS INFORMATION
    payment_status         PaymentStatus @default(PENDING)
    payment_date           DateTime?
    payment_method         PaymentMethod @default(CASH)
    payment_reference      String?
    payment_notes          String?
    paid_by_id             String?
    paid_by                User?         @relation("paid_by", fields: [paid_by_id], references: [id])

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    created_by_id  String
    created_by     User    @relation("created_by", fields: [created_by_id], references: [id])
    received_by_id String?
    received_by    User?   @relation("received_by", fields: [received_by_id], references: [id])
}

enum DispatchStatus {
    DRAFT
    DISPATCHED
    RECEIVED
    DISCREPANCY
    CANCELLED
}

// --- INICIO DE LA ARQUITECTURA DE PRECIOS UNIFICADA ---

model Product {
    id                 Int                @id @default(autoincrement())
    provider_id        Int
    provider           Agency             @relation(fields: [provider_id], references: [id])
    name               String
    description        String?
    type               ProductType        @default(SHIPPING)
    unit               Unit               @default(PER_LB)
    length             Float?
    width              Float?
    height             Float?
    is_active          Boolean            @default(true) // Interruptor Maestro ("Kill Switch")
    created_at         DateTime           @default(now())
    updated_at         DateTime           @updatedAt
    pricing_agreements PricingAgreement[]
    shipping_rates     ShippingRate[]
    services           Service[]

    @@unique([provider_id, name])
}

model PricingAgreement {
    id               Int            @id @default(autoincrement())
    seller_agency_id Int
    buyer_agency_id  Int
    product_id       Int
    product          Product        @relation(fields: [product_id], references: [id])
    service_id       Int
    service          Service        @relation(fields: [service_id], references: [id])
    effective_from   DateTime       @default(now())
    effective_to     DateTime?
    price_in_cents   Int            @default(0)
    is_active        Boolean        @default(true)
    created_at       DateTime       @default(now())
    updated_at       DateTime       @updatedAt
    shipping_rates   ShippingRate[]

    @@unique([seller_agency_id, buyer_agency_id, product_id, service_id])
    @@index([seller_agency_id, buyer_agency_id, product_id, service_id, is_active])
}

model ShippingRate {
    id                   Int              @id @default(autoincrement())
    service_id           Int
    service              Service          @relation(fields: [service_id], references: [id])
    agency_id            Int
    agency               Agency           @relation(fields: [agency_id], references: [id])
    pricing_agreement_id Int
    pricing_agreement    PricingAgreement @relation(fields: [pricing_agreement_id], references: [id])
    scope                RateScope        @default(PUBLIC)
    price_in_cents       Int              @default(0)
    tiers                RateTier[]
    effective_from       DateTime
    effective_to         DateTime?
    is_active            Boolean          @default(true)
    created_at           DateTime         @default(now())
    updated_at           DateTime         @updatedAt
    order_items          OrderItem[]
    product_id           Int
    product              Product          @relation(fields: [product_id], references: [id])

    @@index([agency_id, service_id, scope, is_active])
    @@index([service_id, is_active])
}

/**
 * model DeliveryRate {
 * id                 Int                @id @default(autoincrement())
 * name               String?
 * product_id         Int
 * product            Product            @relation(fields: [product_id], references: [id])
 * carrier_id         Int
 * carrier            Carrier            @relation(fields: [carrier_id], references: [id])
 * agency_id          Int
 * agency             Agency             @relation(fields: [agency_id], references: [id])
 * scope              RateScope          @default(PUBLIC)
 * price_in_cents     Int                @default(0)
 * city_type          CityType?
 * city_id            Int?
 * city               City?              @relation(fields: [city_id], references: [id])
 * effective_from     DateTime
 * effective_to       DateTime?
 * is_active          Boolean            @default(true)
 * created_at         DateTime           @default(now())
 * updated_at         DateTime           @updatedAt
 * order_items        OrderItem[]
 * pricing_agreements PricingAgreement[]
 * @@index([agency_id, carrier_id, city_type, scope, is_active])
 * @@index([carrier_id, city_id, scope, is_active])
 * }
 */

model CustomsRates {
    id           Int         @id @default(autoincrement())
    name         String
    description  String?
    country_id   Int         @default(1)
    country      Country     @relation(fields: [country_id], references: [id])
    chapter      String? // RESTAURADO
    custom_value Float? // RESTAURADO
    price_in_cup Float? // RESTAURADO
    fee_type     FeeType     @default(UNIT)
    fee_in_cents Int         @default(0)
    min_weight   Float? // RESTAURADO
    max_weight   Float? // RESTAURADO
    max_quantity Int? // RESTAURADO
    created_at   DateTime    @default(now())
    updated_at   DateTime    @updatedAt
    order_items  OrderItem[]
    agency       Agency?     @relation(fields: [agencyId], references: [id])
    agencyId     Int?

    @@index([country_id, fee_type]) // For filtering by country and fee type
    @@index([id]) // For pagination ordering
}

model RateTier {
    id               Int          @id @default(autoincrement())
    shipping_rate_id Int
    shipping_rate    ShippingRate @relation(fields: [shipping_rate_id], references: [id], onDelete: Cascade)
    from_weight      Float
    to_weight        Float?
    price_in_cents   Int

    @@index([shipping_rate_id])
}

model Surcharge {
    id             Int           @id @default(autoincrement())
    name           String
    description    String?
    type           SurchargeType
    value          Float
    service_id     Int?
    service        Service?      @relation(fields: [service_id], references: [id])
    agency_id      Int
    agency         Agency        @relation(fields: [agency_id], references: [id])
    is_active      Boolean       @default(true)
    effective_from DateTime
    effective_to   DateTime?

    @@index([agency_id, service_id, is_active])
}

// --- FIN ARQUITECTURA DE PRECIOS ---

// --- MODELOS DE INFRAESTRUCTURA Y SOPORTE ---

model Forwarder {
    id         Int        @id @default(autoincrement())
    name       String     @unique
    logo       String?
    address    String
    contact    String
    phone      String
    email      String
    created_at DateTime   @default(now())
    updated_at DateTime   @updatedAt
    services   Service[]
    agencies   Agency[]
    users      User[]
    providers  Provider[]
    carriers   Carrier[]
    partners   Partner[]
}

model Service {
    id                 Int                @id @default(autoincrement())
    name               String             @unique
    description        String?
    created_at         DateTime           @default(now())
    updated_at         DateTime           @updatedAt
    service_type       ServiceType
    forwarder_id       Int
    forwarder          Forwarder          @relation(fields: [forwarder_id], references: [id])
    provider_id        Int
    provider           Provider           @relation(fields: [provider_id], references: [id])
    carrier_id         Int?
    carrier            Carrier?           @relation(fields: [carrier_id], references: [id])
    agencies           Agency[]
    is_active          Boolean            @default(true)
    order_items        OrderItem[]
    surcharges         Surcharge[]
    volumetric_divisor Int?
    orders             Order[]
    products           Product[]
    pricing_agreements PricingAgreement[]
    shipping_rates     ShippingRate[]
    parcels            Parcel[]
}

model Carrier {
    id           Int       @id @default(autoincrement())
    name         String    @unique
    created_at   DateTime  @default(now())
    updated_at   DateTime  @updatedAt
    forwarder_id Int
    forwarder    Forwarder @relation(fields: [forwarder_id], references: [id])
    services     Service[]
    users        User[]
}

model Provider {
    id         Int         @id @default(autoincrement())
    name       String      @unique
    address    String
    contact    String
    phone      String
    email      String
    logo       String?
    created_at DateTime    @default(now())
    updated_at DateTime    @updatedAt
    services   Service[]
    forwarders Forwarder[]
}

model Province {
    id         Int        @id @default(autoincrement())
    name       String
    created_at DateTime   @default(now())
    updated_at DateTime   @updatedAt
    cities     City[]
    receivers  Receiver[]
}

model City {
    id          Int        @id @default(autoincrement())
    name        String
    created_at  DateTime   @default(now())
    updated_at  DateTime   @updatedAt
    province_id Int
    province    Province   @relation(fields: [province_id], references: [id])
    city_type   CityType   @default(CITY)
    receivers   Receiver[]
}

model Country {
    id            Int            @id @default(autoincrement())
    name          String
    code          String         @unique
    customs_rates CustomsRates[]
}

// --- SECCIN DE PARTNERS (API DE INTEGRACIN) ---

model Partner {
    id           Int          @id @default(autoincrement())
    name         String
    contact_name String
    email        String       @unique
    phone        String
    is_active    Boolean      @default(true)
    agency_id    Int
    agency       Agency       @relation(fields: [agency_id], references: [id], onDelete: Cascade)
    forwarder_id Int
    forwarder    Forwarder    @relation(fields: [forwarder_id], references: [id])
    rate_limit   Int?         @default(100)
    created_at   DateTime     @default(now())
    updated_at   DateTime     @updatedAt
    orders       Order[]
    api_keys     ApiKey[]
    webhooks     Webhook[]
    partner_logs PartnerLog[]
}

model ApiKey {
    id         String       @id @default(uuid())
    key_hash   String       @unique
    prefix     String
    name       String?
    partner_id Int
    partner    Partner      @relation(fields: [partner_id], references: [id], onDelete: Cascade)
    is_active  Boolean      @default(true)
    expires_at DateTime?
    created_at DateTime     @default(now())
    last_used  DateTime?
    logs       PartnerLog[]

    @@index([partner_id, is_active])
    @@index([key_hash])
}

model Webhook {
    id         String         @id @default(uuid())
    partner_id Int
    partner    Partner        @relation(fields: [partner_id], references: [id], onDelete: Cascade)
    url        String
    secret     String
    is_active  Boolean        @default(true)
    events     String[]
    created_at DateTime       @default(now())
    event_logs WebhookEvent[]
}

model WebhookEvent {
    id          String   @id @default(uuid())
    webhook_id  String
    webhook     Webhook  @relation(fields: [webhook_id], references: [id], onDelete: Cascade)
    event_type  String
    payload     Json
    status_code Int?
    response    String?
    is_success  Boolean
    created_at  DateTime @default(now())
}

model PartnerLog {
    id            Int      @id @default(autoincrement())
    api_key_id    String
    api_key       ApiKey   @relation(fields: [api_key_id], references: [id], onDelete: Cascade)
    partner_id    Int
    partner       Partner  @relation(fields: [partner_id], references: [id], onDelete: Cascade)
    endpoint      String
    method        String
    status_code   Int
    request_body  Json?
    response_body Json?
    ip_address    String?
    user_agent    String?
    created_at    DateTime @default(now())

    @@index([api_key_id, created_at])
    @@index([partner_id, created_at])
}

// --- MODELOS DE SOPORTE Y AUTENTICACIN ---

model OrderHistory {
    id             Int            @id @default(autoincrement())
    order_id       Int
    order          Order          @relation(fields: [order_id], references: [id], onDelete: Cascade)
    user_id        String
    user           User           @relation(fields: [user_id], references: [id])
    status         Status
    changed_fields Json
    type           OrderEventType @default(SYSTEM_ACTION)
    comment        String?
    created_at     DateTime       @default(now())
}

model Payment {
    id              Int           @id @default(autoincrement())
    order_id        Int
    order           Order         @relation(fields: [order_id], references: [id], onDelete: Cascade)
    amount_in_cents Int           @default(0)
    charge_in_cents Int           @default(0)
    method          PaymentMethod
    reference       String?
    date            DateTime      @default(now())
    notes           String?
    created_at      DateTime      @default(now())
    updated_at      DateTime      @updatedAt
    user_id         String
    user            User          @relation(fields: [user_id], references: [id])
}

model Discount {
    id                Int          @id @default(autoincrement())
    order_id          Int
    order             Order        @relation(fields: [order_id], references: [id], onDelete: Cascade)
    user_id           String
    user              User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
    type              DiscountType
    description       String?
    rate              Int?         @default(0)
    discount_in_cents Int          @default(0)
    created_at        DateTime     @default(now())
}

model Session {
    id             String   @id @default(uuid())
    expiresAt      DateTime
    token          String   @unique
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
    ipAddress      String?
    userAgent      String?
    userId         String
    user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    impersonatedBy String?

    @@map("session")
}

model Account {
    id                    String    @id @default(uuid())
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    @@unique([providerId, accountId])
    @@map("account")
}

model Counter {
    id         Int      @id @default(autoincrement())
    date       String
    agency_id  Int
    agency     Agency   @relation(fields: [agency_id], references: [id], onDelete: Cascade)
    counter    Int
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@unique([date, agency_id])
}

model Verification {
    id         String   @id @default(uuid())
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@unique([identifier, value])
    @@map("verification")
}

// --- MODELOS DE LOGGING ---
model AppLog {
    id          Int      @id @default(autoincrement())
    level       LogLevel @default(INFO)
    message     String
    source      String // "prisma" | "zod" | "application" | "system" | "http" | "auth" | "database"
    code        String?
    status_code Int?
    details     Json?
    stack       String?
    path        String?
    method      String?
    ip_address  String?
    user_agent  String?
    user_id     String?
    user_email  String?
    user        User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
    created_at  DateTime @default(now())

    @@index([level, created_at(sort: Desc)])
    @@index([source, created_at(sort: Desc)])
    @@index([status_code, created_at(sort: Desc)])
    @@index([user_id, created_at(sort: Desc)])
    @@index([path, created_at(sort: Desc)])
    @@index([created_at(sort: Desc)])
    @@map("app_log")
}

model AppConfig {
    id          Int      @id @default(autoincrement())
    key         String   @unique
    value       String
    description String?
    updated_at  DateTime @default(now()) @updatedAt
    updated_by  String?

    @@map("app_config")
}

enum LogLevel {
    ERROR
    WARN
    INFO
    HTTP
    DEBUG
}

//END MODELOS DE LOGGING ---

enum AgencyType {
    AGENCY
    RESELLER
    FORWARDER
}

enum Roles {
    ROOT
    ADMINISTRATOR
    FORWARDER_RESELLER
    AGENCY_SALES
    AGENCY_ADMIN
    AGENCY_SUPERVISOR
    FORWARDER_ADMIN
    CARRIER_OWNER
    CARRIER_ADMIN
    CARRIER_ISSUES_MANAGER
    CARRIER_WAREHOUSE_WORKER
    MESSENGER
    USER
}

enum ProductType {
    SHIPPING
    DELIVERY
    CUSTOMS
}

enum RateScope {
    PUBLIC
    WHOLESALE
}

enum Unit {
    PER_LB
    PER_KG
    FIXED
    PER_CITY
    PER_VALUE
}

enum SurchargeType {
    PERCENTAGE
    FIXED_AMOUNT
}

enum PaymentStatus {
    PENDING
    PAID
    PARTIALLY_PAID
    FULL_DISCOUNT
    REFUNDED
    CANCELLED
}

enum PaymentMethod {
    CASH
    CREDIT_CARD
    DEBIT_CARD
    BANK_TRANSFER
    PAYPAL
    ZELLE
    CHECK
}

enum DiscountType {
    PERCENTAGE
    CASH
    RATE
    FIXED
    CUSTOM
}

enum ServiceType {
    MARITIME
    AIR
}

enum FeeType {
    UNIT
    WEIGHT
    VALUE
}

enum OrderEventType {
    PAYMENT
    PRIVATE_TRACKING
    PUBLIC_TRACKING
    SYSTEM_ACTION
    ISSUE_REPORTED
}

enum OrderStage {
    BILLING
    WAREHOUSE
    TRANSPORT
    DELIVERY
    COMPLETED
    EXCEPTION
}

enum Status {
    IN_AGENCY
    IN_PALLET
    IN_DISPATCH
    RECEIVED_IN_DISPATCH
    IN_WAREHOUSE
    IN_CONTAINER
    IN_TRANSIT
    AT_PORT_OF_ENTRY
    CUSTOMS_INSPECTION
    RELEASED_FROM_CUSTOMS
    OUT_FOR_DELIVERY
    FAILED_DELIVERY
    PARTIALLY_DELIVERED
    DELIVERED
    RETURNED_TO_SENDER
}

enum CityType {
    SPECIAL
    CAPITAL
    CITY
}

// --- MODELOS DE INCIDENCIAS Y RECLAMACIONES ---

model Issue {
    id          Int           @id @default(autoincrement())
    title       String
    description String
    type        IssueType     @default(COMPLAINT)
    priority    IssuePriority @default(MEDIUM)
    status      IssueStatus   @default(OPEN)

    // Relaci贸n con Order o Parcel (uno u otro, no ambos)
    order_id       Int?
    order          Order?     @relation(fields: [order_id], references: [id], onDelete: Cascade)
    parcel_id      Int?
    parcel         Parcel?    @relation(fields: [parcel_id], references: [id], onDelete: Cascade)
    order_item_hbl String? // Para incidencias espec铆ficas de un item
    order_item     OrderItem? @relation(fields: [order_item_hbl], references: [hbl], onDelete: SetNull)

    // Usuario que crea la incidencia
    created_by_id String
    created_by    User   @relation("created_issues", fields: [created_by_id], references: [id])

    // Usuario asignado para resolver (opcional)
    assigned_to_id String?
    assigned_to    User?   @relation("assigned_issues", fields: [assigned_to_id], references: [id], onDelete: SetNull)

    // Agencia relacionada
    agency_id Int?
    agency    Agency? @relation(fields: [agency_id], references: [id], onDelete: Cascade)

    // Relaciones
    comments         IssueComment[]
    attachments      IssueAttachment[]
    affected_parcels IssueParcel[] // Parcels afectados por esta issue

    // Metadata
    resolved_at      DateTime?
    resolved_by_id   String?
    resolved_by      User?     @relation("resolved_issues", fields: [resolved_by_id], references: [id], onDelete: SetNull)
    resolution_notes String?

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@index([order_id, created_at(sort: Desc)])
    @@index([parcel_id, created_at(sort: Desc)])
    @@index([order_item_hbl])
    @@index([status, created_at(sort: Desc)])
    @@index([agency_id, status])
    @@index([created_by_id, created_at(sort: Desc)])
    @@index([assigned_to_id, status])
    @@index([created_at(sort: Desc)])
}

model IssueComment {
    id          Int      @id @default(autoincrement())
    issue_id    Int
    issue       Issue    @relation(fields: [issue_id], references: [id], onDelete: Cascade)
    user_id     String
    user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
    content     String
    is_internal Boolean  @default(false) // Si es true, solo visible para staff
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt

    @@index([issue_id, created_at(sort: Asc)])
    @@index([user_id])
}

model IssueAttachment {
    id             Int      @id @default(autoincrement())
    issue_id       Int
    issue          Issue    @relation(fields: [issue_id], references: [id], onDelete: Cascade)
    file_url       String // URL del archivo (S3, Cloudinary, etc.)
    file_name      String
    file_type      String // MIME type: image/jpeg, image/png, application/pdf, etc.
    file_size      Int? // Tama帽o en bytes
    uploaded_by_id String
    uploaded_by    User     @relation(fields: [uploaded_by_id], references: [id], onDelete: Cascade)
    description    String? // Descripci贸n opcional de la imagen
    created_at     DateTime @default(now())

    @@index([issue_id, created_at(sort: Desc)])
    @@index([uploaded_by_id])
}

// Tabla de relaci贸n many-to-many para parcels afectados por una issue
model IssueParcel {
    id         Int      @id @default(autoincrement())
    issue_id   Int
    issue      Issue    @relation(fields: [issue_id], references: [id], onDelete: Cascade)
    parcel_id  Int
    parcel     Parcel   @relation(fields: [parcel_id], references: [id], onDelete: Cascade)
    created_at DateTime @default(now())

    @@unique([issue_id, parcel_id]) // Evitar duplicados
    @@index([issue_id])
    @@index([parcel_id])
}

// ============================================
// LEGACY ISSUES - Sistema Legacy Separado
// ============================================

model LegacyIssue {
    id          Int           @id @default(autoincrement())
    title       String
    description String
    type        IssueType     @default(COMPLAINT)
    priority    IssuePriority @default(MEDIUM)
    status      IssueStatus   @default(OPEN)

    // Referencias al sistema legacy MySQL
    legacy_invoice_id Int? // Invoice ID del sistema MySQL
    legacy_order_id   Int? // Order ID del sistema MySQL
    legacy_parcel_id  Int? // Parcel ID del sistema MySQL
    legacy_hbl        String? // HBL/tracking number del sistema legacy

    // Usuario que crea la incidencia
    created_by_id String
    created_by    User   @relation("created_legacy_issues", fields: [created_by_id], references: [id])

    // Usuario asignado para resolver (opcional)
    assigned_to_id String?
    assigned_to    User?   @relation("assigned_legacy_issues", fields: [assigned_to_id], references: [id], onDelete: SetNull)

    // Agencia relacionada (del usuario creador)
    agency_id Int?
    agency    Agency? @relation("legacy_issues", fields: [agency_id], references: [id], onDelete: SetNull)

    // Relaciones
    comments         LegacyIssueComment[]
    attachments      LegacyIssueAttachment[]
    affected_parcels LegacyIssueParcel[] // Parcels afectados del sistema legacy

    // Metadata
    resolved_at      DateTime?
    resolved_by_id   String?
    resolved_by      User?     @relation("resolved_legacy_issues", fields: [resolved_by_id], references: [id], onDelete: SetNull)
    resolution_notes String?

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@index([legacy_invoice_id])
    @@index([legacy_order_id])
    @@index([legacy_parcel_id])
    @@index([legacy_hbl])
    @@index([status, created_at(sort: Desc)])
    @@index([agency_id, status])
    @@index([created_by_id, created_at(sort: Desc)])
    @@index([assigned_to_id, status])
    @@index([created_at(sort: Desc)])
}

// Tabla de relaci贸n para parcels afectados del sistema legacy
model LegacyIssueParcel {
    id               Int         @id @default(autoincrement())
    issue_id         Int
    issue            LegacyIssue @relation(fields: [issue_id], references: [id], onDelete: Cascade)
    legacy_parcel_id String // HBL/tracking number del sistema legacy
    legacy_order_id  Int? // Order ID del sistema legacy (opcional)
    created_at       DateTime    @default(now())

    @@unique([issue_id, legacy_parcel_id]) // Evitar duplicados
    @@index([issue_id])
    @@index([legacy_parcel_id])
}

model LegacyIssueComment {
    id          Int         @id @default(autoincrement())
    issue_id    Int
    issue       LegacyIssue @relation(fields: [issue_id], references: [id], onDelete: Cascade)
    user_id     String
    user        User        @relation("legacy_issue_comments", fields: [user_id], references: [id], onDelete: Cascade)
    content     String
    is_internal Boolean     @default(false) // Si es true, solo visible para staff
    created_at  DateTime    @default(now())
    updated_at  DateTime    @updatedAt

    @@index([issue_id, created_at(sort: Asc)])
    @@index([user_id])
}

model LegacyIssueAttachment {
    id             Int         @id @default(autoincrement())
    issue_id       Int
    issue          LegacyIssue @relation(fields: [issue_id], references: [id], onDelete: Cascade)
    file_url       String // URL del archivo (S3, Cloudinary, etc.)
    file_name      String
    file_type      String // MIME type: image/jpeg, image/png, application/pdf, etc.
    file_size      Int? // Tama帽o en bytes
    uploaded_by_id String
    uploaded_by    User        @relation("legacy_issue_attachments", fields: [uploaded_by_id], references: [id], onDelete: Cascade)
    description    String? // Descripci贸n opcional de la imagen
    created_at     DateTime    @default(now())

    @@index([issue_id, created_at(sort: Desc)])
    @@index([uploaded_by_id])
}

enum IssueType {
    COMPLAINT // Reclamaci贸n
    DAMAGE // Da帽o
    LOSS // P茅rdida
    DELAY // Retraso
    MISSING_ITEM // Art铆culo faltante
    WRONG_ADDRESS // Direcci贸n incorrecta
    OTHER // Otro
}

enum IssuePriority {
    LOW
    MEDIUM
    HIGH
    URGENT
}

enum IssueStatus {
    OPEN // Abierta
    IN_PROGRESS // En progreso
    PENDING // Pendiente de informaci贸n
    RESOLVED // Resuelta
    CLOSED // Cerrada
    CANCELLED // Cancelada
}
