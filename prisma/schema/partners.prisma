model Partner {
  id           Int          @id @default(autoincrement())
  name         String
  contact_name String
  email        String       @unique
  phone        String
  is_active    Boolean      @default(true)
  agency_id    Int
  forwarder_id Int
  rate_limit   Int?         @default(100)
  created_at   DateTime @db.Timestamptz(3)     @default(now())
  updated_at   DateTime @db.Timestamptz(3)     @updatedAt
  api_keys     ApiKey[]
  orders       Order[]
  agency       Agency       @relation(fields: [agency_id], references: [id], onDelete: Cascade)
  forwarder    Forwarder    @relation(fields: [forwarder_id], references: [id])
  partner_logs PartnerLog[]
  webhooks     Webhook[]
}

model ApiKey {
  id         String       @id @default(uuid())
  key_hash   String       @unique
  prefix     String
  name       String?
  partner_id Int
  is_active  Boolean      @default(true)
  expires_at DateTime? @db.Timestamptz(3)
  created_at DateTime @db.Timestamptz(3)     @default(now())
  last_used  DateTime? @db.Timestamptz(3)
  key_plain  String?
  partner    Partner      @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  logs       PartnerLog[]

  @@index([partner_id, is_active])
  @@index([key_hash])
}

model Webhook {
  id         String         @id @default(uuid())
  partner_id Int
  url        String
  secret     String
  is_active  Boolean        @default(true)
  events     String[]
  created_at DateTime @db.Timestamptz(3)       @default(now())
  partner    Partner        @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  event_logs WebhookEvent[]
}

model WebhookEvent {
  id          String   @id @default(uuid())
  webhook_id  String
  event_type  String
  payload     Json
  status_code Int?
  response    String?
  is_success  Boolean
  created_at  DateTime @db.Timestamptz(3) @default(now())
  webhook     Webhook  @relation(fields: [webhook_id], references: [id], onDelete: Cascade)
}

model PartnerLog {
  id            Int      @id @default(autoincrement())
  api_key_id    String
  partner_id    Int
  endpoint      String
  method        String
  status_code   Int
  request_body  Json?
  response_body Json?
  ip_address    String?
  user_agent    String?
  created_at    DateTime @db.Timestamptz(3) @default(now())
  api_key       ApiKey   @relation(fields: [api_key_id], references: [id], onDelete: Cascade)
  partner       Partner  @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@index([api_key_id, created_at])
  @@index([partner_id, created_at])
}
