model Issue {
  id               Int               @id @default(autoincrement())
  title            String
  description      String
  type             IssueType         @default(COMPLAINT)
  priority         IssuePriority     @default(MEDIUM)
  status           IssueStatus       @default(OPEN)
  order_id         Int?
  parcel_id        Int?
  order_item_hbl   String?
  created_by_id    String
  assigned_to_id   String?
  agency_id        Int?
  resolved_at      DateTime? @db.Timestamptz(3)
  resolved_by_id   String?
  resolution_notes String?
  created_at       DateTime @db.Timestamptz(3)          @default(now())
  updated_at       DateTime @db.Timestamptz(3)          @updatedAt
  agency           Agency?           @relation(fields: [agency_id], references: [id], onDelete: Cascade)
  assigned_to      User?             @relation("assigned_issues", fields: [assigned_to_id], references: [id])
  created_by       User              @relation("created_issues", fields: [created_by_id], references: [id])
  order            Order?            @relation(fields: [order_id], references: [id], onDelete: Cascade)
  order_item       OrderItem?        @relation(fields: [order_item_hbl], references: [hbl])
  parcel           Parcel?           @relation(fields: [parcel_id], references: [id], onDelete: Cascade)
  resolved_by      User?             @relation("resolved_issues", fields: [resolved_by_id], references: [id])
  attachments      IssueAttachment[]
  comments         IssueComment[]
  affected_parcels IssueParcel[]

  @@index([order_id, created_at(sort: Desc)])
  @@index([parcel_id, created_at(sort: Desc)])
  @@index([order_item_hbl])
  @@index([status, created_at(sort: Desc)])
  @@index([agency_id, status])
  @@index([created_by_id, created_at(sort: Desc)])
  @@index([assigned_to_id, status])
  @@index([created_at(sort: Desc)])
}

model IssueComment {
  id          Int      @id @default(autoincrement())
  issue_id    Int
  user_id     String
  content     String
  is_internal Boolean  @default(false)
  created_at  DateTime @db.Timestamptz(3) @default(now())
  updated_at  DateTime @db.Timestamptz(3) @updatedAt
  issue       Issue    @relation(fields: [issue_id], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([issue_id, created_at])
  @@index([user_id])
}

model IssueAttachment {
  id             Int      @id @default(autoincrement())
  issue_id       Int
  file_url       String
  file_name      String
  file_type      String
  file_size      Int?
  uploaded_by_id String
  description    String?
  created_at     DateTime @db.Timestamptz(3) @default(now())
  issue          Issue    @relation(fields: [issue_id], references: [id], onDelete: Cascade)
  uploaded_by    User     @relation(fields: [uploaded_by_id], references: [id], onDelete: Cascade)

  @@index([issue_id, created_at(sort: Desc)])
  @@index([uploaded_by_id])
}

model IssueParcel {
  id         Int      @id @default(autoincrement())
  issue_id   Int
  parcel_id  Int
  created_at DateTime @db.Timestamptz(3) @default(now())
  issue      Issue    @relation(fields: [issue_id], references: [id], onDelete: Cascade)
  parcel     Parcel   @relation(fields: [parcel_id], references: [id], onDelete: Cascade)

  @@unique([issue_id, parcel_id])
  @@index([issue_id])
  @@index([parcel_id])
}


