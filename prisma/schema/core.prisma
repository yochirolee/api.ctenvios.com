// ===========================================
// CORE - Modelos principales del sistema
// User, Agency, Customer, Receiver, Forwarder, Provider, Carrier, Service
// ===========================================

model User {
    id                       String                  @id @default(uuid())
    name                     String
    email                    String                  @unique
    emailVerified            Boolean                 @default(false)
    phone                    String?
    image                    String?
    createdAt                DateTime                @default(now())
    updatedAt                DateTime                @updatedAt
    created_by               String?
    forwarder_id             Int?
    forwarder                Forwarder?              @relation(fields: [forwarder_id], references: [id])
    agency_id                Int?
    agency                   Agency?                 @relation(fields: [agency_id], references: [id], onDelete: Cascade)
    carrier_id               Int?
    carrier                  Carrier?                @relation(fields: [carrier_id], references: [id], onDelete: SetNull)
    role                     Roles                   @default(AGENCY_SALES)
    payments                 Payment[]
    discounts                Discount[]
    sessions                 Session[]
    accounts                 Account[]
    banned                   Boolean?                @default(false)
    banReason                String?
    banExpires               DateTime?
    orders                   Order[]                 @relation("user")
    order_history            OrderHistory[]
    created_dispatches       Dispatch[]              @relation("created_by")
    received_dispatches      Dispatch[]              @relation("received_by")
    paid_dispatches          Dispatch[]              @relation("paid_by")
    parcels                  Parcel[]
    parcels_events           ParcelEvent[]
    app_logs                 AppLog[]
    created_issues           Issue[]                 @relation("created_issues")
    assigned_issues          Issue[]                 @relation("assigned_issues")
    resolved_issues          Issue[]                 @relation("resolved_issues")
    issue_comments           IssueComment[]
    issue_attachments        IssueAttachment[]
    created_legacy_issues    LegacyIssue[]           @relation("created_legacy_issues")
    assigned_legacy_issues   LegacyIssue[]           @relation("assigned_legacy_issues")
    resolved_legacy_issues   LegacyIssue[]           @relation("resolved_legacy_issues")
    legacy_issue_comments    LegacyIssueComment[]    @relation("legacy_issue_comments")
    legacy_issue_attachments LegacyIssueAttachment[] @relation("legacy_issue_attachments")
    paid_debts               InterAgencyDebt[]       @relation("DebtPaidBy")
    // Transporte internacional
    created_containers       Container[]             @relation("created_containers")
    container_events         ContainerEvent[]        @relation("container_events")
    created_flights          Flight[]                @relation("created_flights")
    flight_events            FlightEvent[]           @relation("flight_events")
    // Pallets
    created_pallets          Pallet[]                @relation("created_pallets")
    // Warehouses
    managed_warehouses       Warehouse[]             @relation("warehouse_manager")
    // Manifest Verification
    manifest_verifications   ManifestVerification[]  @relation("manifest_verifications")
    discrepancy_resolutions  ManifestDiscrepancy[]   @relation("discrepancy_resolutions")
    // Delivery Routes
    messenger_routes         DeliveryRoute[]         @relation("route_messenger")
    created_routes           DeliveryRoute[]         @relation("route_created_by")
    messenger_assignments    DeliveryAssignment[]    @relation("assignment_messenger")
    // Soft deleted orders
    deleted_orders           Order[]                 @relation("deleted_orders")

    @@index([agency_id, role])
    @@index([carrier_id, role])
    @@map("user")
}

model Agency {
    id                    Int               @id @default(autoincrement())
    name                  String
    address               String
    contact               String
    phone                 String
    email                 String            @unique
    logo                  String?
    website               String?
    created_at            DateTime          @default(now())
    updated_at            DateTime          @updatedAt
    forwarder_id          Int
    forwarder             Forwarder         @relation(fields: [forwarder_id], references: [id])
    parent_agency_id      Int?
    parent_agency         Agency?           @relation("AgencyHierarchy", fields: [parent_agency_id], references: [id], onDelete: SetNull)
    child_agencies        Agency[]          @relation("AgencyHierarchy")
    services              Service[]
    users                 User[]
    products              Product[]
    shipping_rates        ShippingRate[]
    customs_rates         CustomsRates[]
    surcharges            Surcharge[]
    customers             Customer[]        @relation("AgencyToCustomer")
    receivers             Receiver[]        @relation("AgencyToReceiver")
    order_items           OrderItem[]
    counters              Counter[]
    partners              Partner[]
    issues                Issue[]
    legacy_issues         LegacyIssue[]     @relation("legacy_issues")
    agency_type           AgencyType        @default(AGENCY)
    is_active             Boolean           @default(false)
    commission_rate       Float?            @default(0.0)
    orders                Order[]
    created_dispatches    Dispatch[]        @relation("created_dispatches")
    received_dispatches   Dispatch[]        @relation("received_dispatches")
    parcels               Parcel[]
    pallets               Pallet[]
    debtor_debts          InterAgencyDebt[] @relation("DebtorAgency")
    creditor_debts        InterAgencyDebt[] @relation("CreditorAgency")
    original_sender_debts InterAgencyDebt[] @relation("OriginalSenderAgency")

    @@index([forwarder_id, is_active])
    @@index([parent_agency_id])
}

model Customer {
    id                Int        @id @default(autoincrement())
    first_name        String
    middle_name       String?
    last_name         String
    second_last_name  String?
    identity_document String?    @unique
    email             String?    @unique
    mobile            String
    address           String?
    created_at        DateTime   @default(now())
    updated_at        DateTime   @updatedAt
    receivers         Receiver[] @relation("CustomerToReceiver")
    agencies          Agency[]   @relation("AgencyToCustomer")
    is_active         Boolean    @default(true)
    orders            Order[]

    @@unique([mobile, first_name, last_name])
    @@index([created_at(sort: Desc)])
    @@index([id])
    @@index([first_name, last_name])
    @@index([mobile])
}

model Receiver {
    id               Int        @id @default(autoincrement())
    first_name       String
    middle_name      String?
    last_name        String
    second_last_name String?
    passport         String?    @unique
    ci               String     @unique @db.VarChar(11)
    email            String?    @unique
    mobile           String?
    phone            String?
    address          String
    created_at       DateTime   @default(now())
    updated_at       DateTime   @updatedAt
    customers        Customer[] @relation("CustomerToReceiver")
    agencies         Agency[]   @relation("AgencyToReceiver")
    province_id      Int
    province         Province   @relation(fields: [province_id], references: [id])
    city_id          Int
    city             City       @relation(fields: [city_id], references: [id])
    orders           Order[]

    @@index([mobile])
    @@index([ci])
    @@index([first_name, last_name])
}

model Forwarder {
    id         Int         @id @default(autoincrement())
    name       String      @unique
    logo       String?
    address    String
    contact    String
    phone      String
    email      String
    created_at DateTime    @default(now())
    updated_at DateTime    @updatedAt
    services   Service[]
    agencies   Agency[]
    users      User[]
    providers  Provider[]
    carriers   Carrier[]
    partners   Partner[]
    // Transporte internacional
    containers Container[]
    flights    Flight[]
}

model Service {
    id                 Int                @id @default(autoincrement())
    name               String             @unique
    description        String?
    created_at         DateTime           @default(now())
    updated_at         DateTime           @updatedAt
    service_type       ServiceType
    forwarder_id       Int
    forwarder          Forwarder          @relation(fields: [forwarder_id], references: [id])
    provider_id        Int
    provider           Provider           @relation(fields: [provider_id], references: [id])
    carrier_id         Int?
    carrier            Carrier?           @relation(fields: [carrier_id], references: [id])
    agencies           Agency[]
    is_active          Boolean            @default(true)
    order_items        OrderItem[]
    surcharges         Surcharge[]
    volumetric_divisor Int?
    orders             Order[]
    products           Product[]
    pricing_agreements PricingAgreement[]
    shipping_rates     ShippingRate[]
    parcels            Parcel[]
}

model Carrier {
    id              Int             @id @default(autoincrement())
    name            String          @unique
    created_at      DateTime        @default(now())
    updated_at      DateTime        @updatedAt
    forwarder_id    Int
    forwarder       Forwarder       @relation(fields: [forwarder_id], references: [id])
    services        Service[]
    users           User[]
    warehouses      Warehouse[]
    delivery_routes DeliveryRoute[]
}

model Warehouse {
    id              Int             @id @default(autoincrement())
    name            String
    address         String
    carrier_id      Int
    carrier         Carrier         @relation(fields: [carrier_id], references: [id])
    province_id     Int
    province        Province        @relation(fields: [province_id], references: [id])
    is_main         Boolean         @default(false) // Almacén principal del carrier
    is_active       Boolean         @default(true)
    manager_id      String? // Jefe de almacén
    manager         User?           @relation("warehouse_manager", fields: [manager_id], references: [id])
    parcels         Parcel[]
    parcel_events   ParcelEvent[]
    delivery_routes DeliveryRoute[]
    created_at      DateTime        @default(now())
    updated_at      DateTime        @updatedAt

    @@unique([carrier_id, province_id, is_main])
    @@index([carrier_id, is_active])
    @@index([province_id])
}

model Provider {
    id         Int         @id @default(autoincrement())
    name       String      @unique
    address    String
    contact    String
    phone      String
    email      String
    logo       String?
    created_at DateTime    @default(now())
    updated_at DateTime    @updatedAt
    services   Service[]
    forwarders Forwarder[]
    // Transporte internacional
    containers Container[]
    flights    Flight[]
}

model Province {
    id              Int             @id @default(autoincrement())
    code            String          @unique @db.VarChar(2) // DPA code: 21-35, 40
    name            String
    created_at      DateTime        @default(now())
    updated_at      DateTime        @updatedAt
    cities          City[]
    receivers       Receiver[]
    warehouses      Warehouse[]
    delivery_routes DeliveryRoute[]

    @@index([code])
}

model City {
    id          Int        @id @default(autoincrement())
    code        String     @db.VarChar(2) // DPA code within province: 01-15
    name        String
    created_at  DateTime   @default(now())
    updated_at  DateTime   @updatedAt
    province_id Int
    province    Province   @relation(fields: [province_id], references: [id])
    city_type   CityType   @default(CITY)
    receivers   Receiver[]

    @@unique([province_id, code]) // Unique code per province
    @@index([code])
}

model Country {
    id            Int            @id @default(autoincrement())
    name          String
    code          String         @unique
    customs_rates CustomsRates[]
}

model Location {
    id             Int           @id @default(autoincrement())
    name           String
    created_at     DateTime      @default(now())
    updated_at     DateTime      @updatedAt
    parcels        Parcel[]
    parcels_events ParcelEvent[]
}
